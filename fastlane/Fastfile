require 'dotenv'
Dotenv.load('.env')   # âœ… è‡ªåŠ¨åŠ è½½ .env æ–‡ä»¶å†…å®¹

default_platform(:ios)

username          = ENV["FASTLANE_USER"]
asc_key_id        = ENV["ASC_KEY_ID"]
asc_issuer_id     = ENV["ASC_ISSUER_ID"]
asc_key_filepath  = ENV["ASC_KEY_FILEPATH"]

scheme            = ENV["SCHEME"]
bundle_id         = ENV["BUNDLE_ID"]
app_name          = ENV["APP_NAME"]
export_method     = ENV["EXPORT_METHOD"] || "app-store"
team_id           = ENV["TEAM_ID"]

platform :ios do

  ######################################################
  # ğŸ”¹ å…¬å…±é¢„å¤„ç†
  ######################################################
  before_all do |lane, options|
    UI.header "ğŸš€ Start Build Environment Setup"
    UI.important "ğŸ‘¤ FASTLANE_USER: #{username}"
    UI.important "ğŸ”‘ ASC_KEY_ID: #{asc_key_id}"
    UI.important "ğŸ¢ TEAM_ID: #{team_id}"
    UI.important "ğŸ“¦ BUNDLE_ID: #{bundle_id}"
    UI.important "ğŸ“± SCHEME: #{scheme}"
    UI.important "ğŸ§¾ EXPORT_METHOD: #{export_method}"
    setup_circle_ci
  end

  ######################################################
  # âœ… ä¸»å‘å¸ƒ Laneï¼šç­¾å + æ‰“åŒ…
  ######################################################
  lane :release do
    on_match
    prepare_gym

    profile_name = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING][bundle_id]

    gym(
      scheme: scheme,
      configuration: "Release",
      clean: true,
      export_method: export_method,
      output_directory: "./build",
      output_name: "#{app_name}.ipa",
      export_options: {
        provisioningProfiles: {
          bundle_id => profile_name
        }
      }
    )

    UI.success("âœ… æ‰“åŒ…å®Œæˆï¼IPA æ–‡ä»¶å·²è¾“å‡ºåˆ° ./build/#{app_name}.ipa")
  end

  ######################################################
  # âœ… è‡ªåŠ¨ç­¾ååŒ¹é…ï¼ˆæ”¯æŒè‡ªæ„ˆï¼‰
  ######################################################
  lane :on_match do
    UI.header "ğŸ” Checking Signing Certificates..."

    app_store_connect_api_key(
      key_id: asc_key_id,
      issuer_id: asc_issuer_id,
      key_filepath: asc_key_filepath,
      in_house: false
    )

    begin
      UI.important("ğŸ§­ å°è¯•ä½¿ç”¨ç°æœ‰ App Store è¯ä¹¦å’Œæè¿°æ–‡ä»¶...")
      match_result = match(
        git_branch: username,
        username: username,
        type: "appstore",
        app_identifier: [bundle_id],
        readonly: true
      )
      UI.success("âœ… å·²æ‰¾åˆ°å¯ç”¨ App Store è¯ä¹¦å’Œæè¿°æ–‡ä»¶")
    rescue => e
      UI.important("âš ï¸ è¯ä¹¦å¯èƒ½å·²å¤±æ•ˆæˆ–è¢«æ’¤é”€ï¼Œå‡†å¤‡é‡æ–°ç”Ÿæˆ...")
      match_result = match(
        git_branch: username,
        username: username,
        type: "appstore",
        app_identifier: [bundle_id],
        readonly: false,                 # âœ… å…è®¸è‡ªåŠ¨ä¿®å¤
        force_for_new_devices: true
      )
      UI.success("âœ… æ–°çš„ç­¾åè¯ä¹¦å’Œæè¿°æ–‡ä»¶å·²æˆåŠŸåˆ›å»º")
    end

    profiles = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
    UI.important("ğŸ“œ å½“å‰ä½¿ç”¨çš„æè¿°æ–‡ä»¶æ˜ å°„: #{profiles}")
  end

  ######################################################
  # âœ… æ›´æ–° Xcode ç­¾åé…ç½®
  ######################################################
  lane :prepare_gym do
    UI.header "ğŸ§© Preparing Code Signing Settings..."
    profile_name = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING][bundle_id]
    unless profile_name
      UI.user_error!("âš ï¸ æ²¡æœ‰æ‰¾åˆ°æè¿°æ–‡ä»¶ï¼Œè¯·å…ˆæ‰§è¡Œ on_match æˆåŠŸåé‡è¯•")
    end

    update_code_signing_settings(
      use_automatic_signing: false,
      profile_name: profile_name,
      targets: [scheme],
      build_configurations: ["Release"],
      team_id: team_id
    )

    UI.success("âœ… ç­¾åé…ç½®å·²æ›´æ–°ï¼Œå‡†å¤‡æ‰“åŒ…")
  end

end