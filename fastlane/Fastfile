require 'dotenv'
Dotenv.load('.env')   # âœ… è‡ªåŠ¨åŠ è½½ .env æ–‡ä»¶å†…å®¹

default_platform(:ios)

username         = ENV["FASTLANE_USER"]
asc_key_id       = ENV["ASC_KEY_ID"]
asc_issuer_id    = ENV["ASC_ISSUER_ID"]
asc_key_filepath = ENV["ASC_KEY_FILEPATH"]

scheme        = ENV["SCHEME"]
bundle_id     = ENV["BUNDLE_ID"]
app_name      = ENV["APP_NAME"]
export_method = ENV["EXPORT_METHOD"] || "app-store"  # é»˜è®¤ app-store

platform :ios do

  before_all do |lane, options|
    UI.header "Step: before_all"
    UI.important "username = #{username}"
    UI.important "asc_key_id = #{asc_key_id}"
    UI.important "asc_issuer_id = #{asc_issuer_id}"
    UI.important "asc_key_content = #{asc_key_filepath}"
    UI.important "bundle_id = #{bundle_id}"
    UI.important "app_name = #{app_name}"
    UI.important "export_method = #{export_method}"

    setup_circle_ci
  end

  ######################################################
  # ğŸ›  ä¸€é”®ä¿®å¤è¯ä¹¦ + æ‰“åŒ… IPA
  ######################################################
  lane :release do
    # 1ï¸âƒ£ æ£€æŸ¥è¯ä¹¦
    UI.header("Step 1ï¸âƒ£: æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§")
    begin
      match_result = match(
        type: "appstore",
        readonly: true,
        app_identifier: [bundle_id],
        username: username
      )
      UI.success("âœ… æ‰¾åˆ°å¯ç”¨è¯ä¹¦")
    rescue => e
      UI.important("âš ï¸ æ²¡æœ‰å¯ç”¨è¯ä¹¦æˆ–è¯ä¹¦è¿‡æœŸ: #{e}")

      # 2ï¸âƒ£ ç”Ÿæˆæ–°è¯ä¹¦ + æè¿°æ–‡ä»¶
      UI.header("Step 2ï¸âƒ£: ç”Ÿæˆæ–°è¯ä¹¦å’Œæè¿°æ–‡ä»¶")
      match_result = match(
        type: "appstore",
        readonly: false,
        force_for_new_devices: true,
        app_identifier: [bundle_id],
        username: username
      )
      UI.success("âœ… æ–°è¯ä¹¦å’Œæè¿°æ–‡ä»¶ç”Ÿæˆå®Œæˆ")
    end

    # 3ï¸âƒ£ æ›´æ–°é¡¹ç›®ç­¾åé…ç½®
    UI.header("Step 3ï¸âƒ£: æ›´æ–°ç­¾åé…ç½®")
    profile_name = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING][bundle_id]
    unless profile_name
      UI.user_error!("âŒ æ‰¾ä¸åˆ°æè¿°æ–‡ä»¶ï¼Œè¯·ç¡®è®¤ match æˆåŠŸ")
    end

    update_code_signing_settings(
      use_automatic_signing: false,
      profile_name: profile_name,
      targets: [scheme],
      build_configurations: ["Release"],
      team_id: ENV["TEAM_ID"]
    )
    UI.success("âœ… ç­¾åé…ç½®å·²æ›´æ–°")

    # 4ï¸âƒ£ æ‰“åŒ… IPA
    UI.header("Step 4ï¸âƒ£: æ‰“åŒ… IPA")
    gym(
      scheme: scheme,
      configuration: "Release",
      export_method: export_method,
      clean: true,
      output_directory: "./build",
      output_name: "#{app_name}.ipa"
    )

    UI.success("ğŸ‰ æ‰“åŒ…å®Œæˆï¼IPA æ–‡ä»¶å·²è¾“å‡ºåˆ° ./build/#{app_name}.ipa")
  end

end
